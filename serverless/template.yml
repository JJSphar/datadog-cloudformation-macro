AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31

Description: Simplified configuration of the datadog macro stack that can be deployed using SAM. Useful for hotpatching the Macro's code.

Parameters:
  FunctionName:
    Type: String
    Default: DatadogServerlessMacroLambda
    Description: The name of the Lambda function that is invoked when the macro is run.
  LogRetentionInDays:
    Type: Number
    Default: 90
    Description: CloudWatch log retention for logs generated by the Datadog Serverless Macro Lambda function
  VerionNumber:
    Type: String
    Description: Version of the macro to publish

Conditions:
  SetFunctionName:
    Fn::Not:
      - Fn::Equals:
          - Ref: FunctionName
          - "DatadogServerlessMacroLambda"

Resources:
  MacroFunction:
    Type: AWS::Serverless::Function
    DependsOn: MacroFunctionZip
    Properties:
      FunctionName:
        Fn::If:
          - SetFunctionName
          - Ref: FunctionName
          - Ref: AWS::NoValue
      Description: Processes a CloudFormation template to install Datadog Lambda layers for Python and Node.js Lambda functions.
      Handler: src/index.handler
      Runtime: nodejs12.x
      CodeUri: .
      Tags:
        dd_serverless_macro_version: !Ref VerionNumber

  MacroFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${MacroFunction}
      RetentionInDays:
        Ref: LogRetentionInDays

  Macro:
    Type: AWS::CloudFormation::Macro
    Properties:
      Name: DatadogServerlessCustom
      FunctionName: !GetAtt MacroFunction.Arn
